{% extends 'base.html' %}
{% load static %}

{% block content %}

<section class="section-content padding-y bg">
  <div class="container">

    <div class="row">
      <aside class="col-lg-6">
        <div class="card">
          <div class="card-body">
            <h4 class="card-title mb-4">Dirección de facturación</h4>

            <form action="{% url 'realizar_pedido' %}" method="POST">
              {% csrf_token %}
              {{ formulario.non_field_errors }}

              <div class="form-row">
                <div class="col form-group">
                  {{ formulario.nombre.label_tag }}
                  {{ formulario.nombre }}
                  {{ formulario.nombre.errors }}
                </div>
                <div class="col form-group">
                  {{ formulario.apellido.label_tag }}
                  {{ formulario.apellido }}
                  {{ formulario.apellido.errors }}
                </div>
              </div>

              <div class="form-row">
                <div class="col form-group">
                  {{ formulario.correo.label_tag }}
                  {{ formulario.correo }}
                  {{ formulario.correo.errors }}
                </div>
                <div class="col form-group">
                  {{ formulario.telefono.label_tag }}
                  {{ formulario.telefono }}
                  {{ formulario.telefono.errors }}
                </div>
              </div>

              <div class="form-row">
                <div class="col form-group">
                  {{ formulario.direccion_1.label_tag }}
                  {{ formulario.direccion_1 }}
                  {{ formulario.direccion_1.errors }}
                </div>
                <div class="col form-group">
                  {{ formulario.direccion_2.label_tag }}
                  {{ formulario.direccion_2 }}
                  {{ formulario.direccion_2.errors }}
                </div>
              </div>

              <div class="form-row">
                <div class="col form-group">
                  {{ formulario.ciudad.label_tag }}
                  {{ formulario.ciudad }}
                  {{ formulario.ciudad.errors }}
                </div>
                <div class="col form-group">
                  {{ formulario.provincia.label_tag }}
                  {{ formulario.provincia }}
                  {{ formulario.provincia.errors }}
                </div>
                <div class="col form-group">
                  {{ formulario.pais.label_tag }}
                  {{ formulario.pais }}
                  {{ formulario.pais.errors }}
                </div>
              </div>

              <div class="form-row">
                {{ formulario.nota_orden.label_tag }}
                {{ formulario.nota_orden }}
                {{ formulario.nota_orden.errors }}
              </div>

          </div>
        </div> <!-- card.// -->

      </aside> <!-- col.// -->

      <aside class="col-lg-6">
        <div class="card">
          <div class="card-body">

            <table class="table table-borderless table-shopping-cart">
              <thead class="text-muted">
                <tr class="small text-uppercase">
                  <th scope="col">Producto</th>
                  <th scope="col" width="120">Cantidad</th>
                  <th scope="col" width="120">Precio</th>
                </tr>
              </thead>
              <tbody>
                {% for item_carrito in items_carrito %}
                <tr>
                  <td>
                    <figure class="itemside align-items-center">
                      <div class="aside"><img src="{{ item_carrito.producto.imagen.url }}" class="img-sm"></div>
                      <figcaption class="info">
                        <a href="{{ item_carrito.producto.get_url }}" class="title text-dark">
                          {{ item_carrito.producto.nombre_producto }}</a>
                        <p class="text-muted small">
                          {% if item_carrito.variaciones.all %}
                          {% for item in item_carrito.variaciones.all %}
                          {{ item.categoria_variacion | capfirst }} : {{ item.valor_variacion | capfirst }} <br>
                          {% endfor %}
                          {% endif %}
                        </p>
                      </figcaption>
                    </figure>
                  </td>
                  <td><label>{{ item_carrito.cantidad }}</label></td>
                  <td>
                    <div class="price-wrap">
                      <var class="price">$ {{ item_carrito.subtotal }}</var>
                      <small class="text-muted">$ {{ item_carrito.producto.precio }} c/u </small>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>

            <hr>
            <h5>Opciones de Entrega</h5>
            <label>
              <input type="radio" name="tipo_entrega" value="domicilio" {% if formulario.tipo_entrega.value == 'domicilio' %}checked{% endif %}>
              Envío a domicilio
            </label>
            <label>
              <input type="radio" name="tipo_entrega" value="retiro_local" {% if formulario.tipo_entrega.value == 'retiro_local' %}checked{% endif %}>
              Retiro en local
            </label>

            <div id="campos_domicilio" style="margin-top:15px;">
              <div class="form-row">
                <div class="col form-group">
                  <label for="id_direccion_envio">Dirección de envío</label>
                  {{ formulario.direccion_envio }}
                  {{ formulario.direccion_envio.errors }}
                </div>
                <div class="col form-group">
                  <label for="id_ciudad_envio">Ciudad de envío</label>
                  {{ formulario.ciudad_envio }}
                  {{ formulario.ciudad_envio.errors }}
                </div>
                <div class="col form-group">
                  <label for="id_cp_envio">Código Postal</label>
                  {{ formulario.cp_envio }}
                  {{ formulario.cp_envio.errors }}
                </div>
              </div>

              {% if cotizacion_envio %}
              <div class="alert alert-info my-3">
                <strong>Costo de envío Correo Argentino:</strong> ${{ cotizacion_envio.costo }}
                <br>
                <span class="small text-muted">Tiempo estimado: {{ cotizacion_envio.tiempo_entrega }}</span>
              </div>
              {% endif %}
            </div>

            <script>
              document.addEventListener("DOMContentLoaded", function () {
                const radios = document.querySelectorAll('input[name="tipo_entrega"]');
                const campos = document.getElementById("campos_domicilio");

                function toggleCampos() {
                  const seleccionado = document.querySelector('input[name="tipo_entrega"]:checked').value;
                  campos.style.display = (seleccionado === "domicilio") ? "block" : "none";
                }

                radios.forEach(radio => {
                  radio.addEventListener("change", toggleCampos);
                });

                toggleCampos();
              });
            </script>

            <button type="submit" name="calcular_envio" class="btn btn-info btn-block mt-3">Calcular envío</button>
            <button name="realizar_pedido" type="submit" class="btn btn-primary btn-block mt-3">Realizar pedido</button>
            <a href="{% url 'tienda' %}" class="btn btn-light btn-block mt-2">Continuar comprando</a>

            </form>
          </div>
        </div>
      </aside>
    </div>

  </div>
</section>

{% endblock %}