{% extends 'base.html' %}
{% load static %}

{% block content %}

<section class="section-content padding-y bg">
  <div class="container">

    <div class="row">
      <!-- DIRECCI칍N DE FACTURACI칍N -->
      <aside class="col-lg-6">
        <div class="card mb-3 shadow-sm">
          <div class="card-body">
            <h4 class="card-title mb-4">Direcci칩n de facturaci칩n</h4>

            <form id="checkoutForm" action="{% url 'realizar_pedido' %}" method="POST">
              {% csrf_token %}
              {{ formulario.non_field_errors }}

              <div class="form-group mb-2">
                {{ formulario.nombre.label_tag }}
                {{ formulario.nombre }}
                {{ formulario.nombre.errors }}
              </div>
              <div class="form-group mb-2">
                {{ formulario.apellido.label_tag }}
                {{ formulario.apellido }}
                {{ formulario.apellido.errors }}
              </div>
              <div class="form-group mb-2">
                {{ formulario.correo.label_tag }}
                {{ formulario.correo }}
                {{ formulario.correo.errors }}
              </div>
              <div class="form-group mb-2">
                {{ formulario.telefono.label_tag }}
                {{ formulario.telefono }}
                {{ formulario.telefono.errors }}
              </div>
              <div class="form-group mb-2">
                {{ formulario.direccion_1.label_tag }}
                {{ formulario.direccion_1 }}
                {{ formulario.direccion_1.errors }}
              </div>
              <div class="form-group mb-2">
                {{ formulario.direccion_2.label_tag }}
                {{ formulario.direccion_2 }}
                {{ formulario.direccion_2.errors }}
              </div>
              <div class="form-group mb-2">
                {{ formulario.ciudad.label_tag }}
                {{ formulario.ciudad }}
                {{ formulario.ciudad.errors }}
              </div>
              <div class="form-group mb-2">
                {{ formulario.provincia.label_tag }}
                {{ formulario.provincia }}
                {{ formulario.provincia.errors }}
              </div>
              <div class="form-group mb-2">
                {{ formulario.pais.label_tag }}
                {{ formulario.pais }}
                {{ formulario.pais.errors }}
              </div>
              <div class="form-group mb-2">
                {{ formulario.nota_orden.label_tag }}
                {{ formulario.nota_orden }}
                {{ formulario.nota_orden.errors }}
              </div>

              <!-- Input oculto para costo de env칤o -->
              <input type="hidden" id="input_costo_envio" name="costo_envio" value="0">
          </div>
        </div>
      </aside>

      <!-- PRODUCTOS Y ENTREGA -->
      <aside class="col-lg-6">
        <div class="card mb-3 shadow-sm">
          <div class="card-body">

            <!-- Productos -->
            <div class="card mb-3 shadow-sm">
              <div class="card-header bg-light">
                <h5 class="mb-0">Productos en tu carrito</h5>
              </div>
              <div class="card-body p-2">
                <table class="table table-borderless mb-0">
                  <thead class="text-muted small text-uppercase">
                    <tr>
                      <th>Producto</th>
                      <th width="120">Cantidad</th>
                      <th width="120">Precio</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for item_carrito in items_carrito %}
                    <tr>
                      <td>
                        <figure class="itemside align-items-center">
                          <div class="aside"><img src="{{ item_carrito.producto.imagen.url }}" class="img-sm rounded"></div>
                          <figcaption class="info">
                            <a href="{{ item_carrito.producto.get_url }}" class="title text-dark">{{ item_carrito.producto.nombre_producto }}</a>
                            <p class="text-muted small mb-0">
                              {% if item_carrito.variaciones.all %}
                                {% for item in item_carrito.variaciones.all %}
                                  {{ item.categoria_variacion | capfirst }} : {{ item.valor_variacion | capfirst }}<br>
                                {% endfor %}
                              {% endif %}
                            </p>
                          </figcaption>
                        </figure>
                      </td>
                      <td><span class="badge bg-secondary">{{ item_carrito.cantidad }}</span></td>
                      <td>
                        <div class="price-wrap">
                          <var class="price fw-bold">$ {{ item_carrito.subtotal }}</var>
                          <small class="text-muted d-block">$ {{ item_carrito.producto.precio }} c/u</small>
                        </div>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              <div>
                <div class="text-end mt-3 border-top pt-2">
                <h5 class="fw-bold">Total: $<span id="total_carrito">{{ total }}</span></h5>
              </div>
              </div>
            </div>

            <!-- Opciones de entrega -->
            <div class="card mb-3 shadow-sm p-3">
              <h5>Opciones de entrega</h5>
              <div class="d-flex gap-3 mb-2">
                <label class="form-check-label">
                  <input class="form-check-input me-2" type="radio" name="tipo_entrega" value="domicilio" {% if formulario.tipo_entrega.value == 'domicilio' %}checked{% endif %}>
                  Env칤o a domicilio
                </label>
                <label class="form-check-label">
                  <input class="form-check-input me-2" type="radio" name="tipo_entrega" value="retiro_local" {% if formulario.tipo_entrega.value == 'retiro_local' %}checked{% endif %}>
                  Retiro en local
                </label>
              </div>

              <div id="campos_domicilio" class="mt-2" style="display:none;">
                <div class="mb-2">
                  {{ formulario.direccion_envio.label_tag }}
                  {{ formulario.direccion_envio }}
                  {{ formulario.direccion_envio.errors }}
                </div>
                <div class="mb-2">
                  {{ formulario.ciudad_envio.label_tag }}
                  {{ formulario.ciudad_envio }}
                  {{ formulario.ciudad_envio.errors }}
                </div>
                <div class="mb-2">
                  {{ formulario.cp_envio.label_tag }}
                  {{ formulario.cp_envio }}
                  {{ formulario.cp_envio.errors }}
                </div>

                <!-- 游댳 Resultado del c치lculo -->
                <div id="resultado_envio" class="alert alert-info my-2 small" style="display:none;">
                  <strong>Costo de env칤o:</strong> $<span id="costo_envio"></span><br>
                  <span class="text-muted">Tiempo estimado: 2-5 d칤as</span>
                </div>

                <button type="button" class="btn btn-info btn-sm mt-2" id="btn_calcular_envio">Calcular env칤o</button>
              
              </div>
            </div>

            <!-- Botones -->
            <div class="d-flex gap-2">
              <button name="realizar_pedido" type="submit" class="btn btn-primary flex-fill">Realizar pedido</button>
              <a href="{% url 'tienda' %}" class="btn btn-outline-secondary flex-fill">Continuar comprando</a>
            </div>

          </div>
        </div>
      </aside>
    </div>

  </div>
</section>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const radios = document.querySelectorAll('input[name="tipo_entrega"]');
  const campos = document.getElementById("campos_domicilio");
  const btnCalcular = document.getElementById("btn_calcular_envio");
  const resultado = document.getElementById("resultado_envio");
  const costoEnvioSpan = document.getElementById("costo_envio");
  const ciudadEnvioInput = document.getElementById("id_ciudad_envio");
  const inputCostoEnvio = document.getElementById("input_costo_envio");
  const totalCarritoSpan = document.getElementById("total_carrito");
  const totalInicial = parseFloat(totalCarritoSpan.textContent);

  function toggleCampos() {
    const radioSeleccionado = document.querySelector('input[name="tipo_entrega"]:checked');
    if (!radioSeleccionado) return;
    const mostrarDomicilio = (radioSeleccionado.value === "domicilio");
    campos.style.display = mostrarDomicilio ? "block" : "none";
    btnCalcular.style.display = mostrarDomicilio ? "block" : "none";

    // Si se cambia a retiro, reiniciamos costo de env칤o
    if (!mostrarDomicilio) {
      inputCostoEnvio.value = 0;
      costoEnvioSpan.textContent = "0.00";
      totalCarritoSpan.textContent = totalInicial.toFixed(2);
      resultado.style.display = "none";
    }
  }

  btnCalcular.addEventListener("click", async () => {
    const ciudadDestino = ciudadEnvioInput.value.trim();
    if (!ciudadDestino) {
      alert("Por favor, ingres치 una ciudad de destino.");
      return;
    }

    try {
      const response = await fetch(`/calcular_envio?destino=${encodeURIComponent(ciudadDestino)}`);
      if (!response.ok) throw new Error("Error al obtener el costo de env칤o");
      const data = await response.json();

      costoEnvioSpan.textContent = data.costo_envio.toFixed(2);
      inputCostoEnvio.value = data.costo_envio;

      // Actualizar total sumando costo de env칤o
      const totalConEnvio = totalInicial + data.costo_envio;
      totalCarritoSpan.textContent = totalConEnvio.toFixed(2);

      resultado.style.display = "block";
    } catch (error) {
      alert("No se pudo calcular el env칤o. Intent치 nuevamente.");
      console.error(error);
    }
  });

  radios.forEach(radio => radio.addEventListener("change", toggleCampos));
  toggleCampos();
});
</script>

{% endblock %}

